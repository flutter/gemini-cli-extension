# To create a new release,
# 1) Tag the git ref you would like to release with a version number starting with "v".
# 2) Push that tag to Github with git push.
#
# E.g.:
# git tag v1.0.0 && git push upstream v1.0.0

name: Create Release

on:
  push:
    tags:
      - "v*"

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create archive
        run: |
          tag_name=${GITHUB_REF#refs/tags/}
          archive_name="flutter.tar.gz"
          git archive --format=tar.gz -o $archive_name $tag_name \
            gemini-extension.json \
            commands/ \
            override \
            LICENSE \
            README.md \
            flutter.md
          for architecture in linux macos win32; do
            architecture_name="$architecture.$archive_name"
            cp "$archive_name" "$architecture_name"
            echo "${architecture^^}_ARCHIVE_NAME=$architecture_name" >> $GITHUB_ENV
          done

      - name: Create GitHub Release with GH CLI
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ github.ref_name }} \
            --generate-notes \
            ${{ env.LINUX_ARCHIVE_NAME }} \
            ${{ env.MACOS_ARCHIVE_NAME }} \
            ${{ env.WIN32_ARCHIVE_NAME }}
